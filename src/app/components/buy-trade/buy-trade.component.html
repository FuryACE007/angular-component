<app-navbar></app-navbar>
<div class="form-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title> Buy Trade </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="buyForm" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="fill">
          <mat-label>Instrument</mat-label>
          <mat-select formControlName="instrumentId">
            <mat-option
              *ngFor="let instrument of instruments"
              [value]="instrument.instrumentId"
            >
              {{ instrument.description }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="buyForm.get('instrumentId')?.hasError('required')">
            Instrument is required.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Quantity</mat-label>
          <input matInput type="number" formControlName="quantity" />
          <mat-error *ngIf="buyForm.get('quantity')?.hasError('required')">
            Quantity is required.
          </mat-error>
          <mat-error *ngIf="buyForm.get('quantity')?.hasError('min')">
            Quantity must be at least 1.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Target Price</mat-label>
          <input matInput type="number" formControlName="targetPrice" />
          <mat-error *ngIf="buyForm.get('targetPrice')?.hasError('required')">
            Target Price is required.
          </mat-error>
          <mat-error *ngIf="buyForm.get('targetPrice')?.hasError('min')">
            Target Price must be a positive number.
          </mat-error>
          <mat-error *ngIf="!isTargetPriceValid()">
            Invalid target price. Must be within 5% of the bid price.
          </mat-error>
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="
            buyForm.invalid ||
            client.cash < buyForm.value.quantity * buyForm.value.targetPrice
          "
        >
          Buy
        </button>
      </form>

      <div *ngIf="selectedInstrumentCost">
        <p>Ask Price: {{ selectedInstrumentCost.askPrice }}</p>
        <p>Bid Price: {{ selectedInstrumentCost.bidPrice }}</p>
      </div>

      <!-- Display feedback if client cash is insufficient -->
      <div
        *ngIf="client.cash < buyForm.value.quantity * buyForm.value.targetPrice"
      >
        <mat-error> Insufficient funds to complete the transaction. </mat-error>
      </div>
    </mat-card-content>
  </mat-card>
</div>
<mat-card *ngIf="client">
  <mat-card-content>
    Available cash: {{ client.cash | currency }}
  </mat-card-content>
</mat-card>
